<main class="m-2">
  <section class="flex flex-column md:flex-row  md:align-items-center justify-content-between mb-5">
    <div class="flex flex-grow-1 align-items-center flex-basis-0">
      <p-button 
        label="Volver" 
        icon="pi pi-arrow-left" 
        severity="secondary"
        [text]="true"
        (onClick)="back()" 
      />
    </div>
    <div class="flex flex-grow-1 align-items-center justify-content-center md:justify-content-start">
      <h1 class="text-5xl my-0">Nueva aplicación</h1>
    </div>
  </section>
  
  <div *ngIf="isLoading; else newAppForm" class="card flex justify-content-center my-6">
    <p-progressSpinner ariaLabel="loading" />
  </div>

  <ng-template #newAppForm class="main-container mt-6">
    <div class="container-stepper font-medium p-1 mt-2 md:p-4">
      <form [formGroup]="formFiles">
        <p-stepper [linear]="true">
          <p-stepperPanel header="Acciones">
            <ng-template pTemplate="content" let-nextCallback="nextCallback" let-index="index">
              <div class="flex flex-column justify-content-center align-items-center h-23rem border-round surface-ground px-3">
                <p>Selecciona la acción a realizar:</p>
                <div class="flex flex-column gap-3">
                  <div *ngFor="let opc of actionsOps" class="field-checkbox">
                    <p-radioButton 
                      [value]="opc.value" 
                      formControlName="action" 
                      [inputId]="opc.txt"/>
                      <label [for]="opc.txt" class="ml-2">
                        {{ opc.txt }}
                      </label>
                    </div>
                  </div>
                <div 
                  *ngIf="formFiles.controls['action'].value === 3" 
                  class="flex flex-column justify-content-center align-items-center mb-3">
                    <p>Selecciona el lenguaje al que se quiere migrar:</p>
                    <p-dropdown 
                      formControlName="language"
                      [options]="lenguagesOps"
                      optionLabel="nom_lenguaje"
                      optionValue="idu_lenguaje"
                      placeholder="Selecciona un lenguaje" />
                      <span
                        *ngIf="formFiles.controls['language'].value === null && formFiles.controls['language'].touched" 
                        class="font-italic text-red-500 mt-2">
                          Debes seleccionar un lenguaje.
                      </span>
                    </div>
              </div>
              <div class="flex pt-4 justify-content-end">
                <p-button label="Siguiente" icon="pi pi-arrow-right" 
                  iconPos="right" (onClick)="nextCallback.emit()"
                  [disabled]="formFiles.controls['action'].errors || 
                    (formFiles.controls['action'].value === 3 && formFiles.controls['language'].value === null)"
                />
              </div>
            </ng-template>
          </p-stepperPanel>
          <p-stepperPanel header="Tipo de proyecto">
            <ng-template pTemplate="content" let-prevCallback="prevCallback" let-nextCallback="nextCallback" let-index="index">
              <div class="flex flex-column justify-content-center align-items-center h-18rem border-round surface-ground px-3">
                <p>Selecciona el tipo de proyecto que se subirá:</p>
                <div class="flex-auto flex justify-content-center align-items-center">
                  <div class="flex align-items-center mx-3 py-2 px-3" *ngFor="let option of radioOps">
                    <p-radioButton 
                    [inputId]="option.value" 
                          [value]="option.value"
                          formControlName="type"
                        />
                      <label [for]="option.value" class="ml-3 label-btn">
                        <img 
                          src="assets/images/{{option.image}}" 
                          [alt]="option.value"
                          [pTooltip]="option.tooltip" 
                          tooltipPosition="bottom" >
                        </label>
                    </div>
                  </div>
                </div>
                <div class="flex pt-4 justify-content-between">
                  <p-button label="Regresar" [outlined]="true" 
                  icon="pi pi-arrow-left" (onClick)="prevCallback.emit()"/>
                <p-button label="Siguiente" icon="pi pi-arrow-right" iconPos="right" (onClick)="nextCallback.emit()" />
              </div>
            </ng-template>
          </p-stepperPanel>
          <p-stepperPanel header="Seleccionar proyecto">
            <ng-template pTemplate="content" let-prevCallback="prevCallback" let-nextCallback="nextCallback" let-index="index">
              <div *ngIf="formFiles.get('type')?.value === 'zip'" class="h-18rem border-round surface-ground conteiner-panel">
                <p class="">Selecciona el archivo <strong>.zip</strong> o <strong>.7z</strong> de tu proyecto</p>
                <div class="flex-auto flex flex-column justify-content-center align-items-center">
                  <p-inputGroup>
                    <button type="button" pButton label="Buscar" (click)="triggerFileInput('zip')"></button>
                    <input type="text" pInputText 
                    id="inputNameZip"
                      placeholder="Selecciona tu proyecto" 
                      readonly disabled="true"
                      [value]="formFiles.controls['zipFile'].value?.name ?? ''"/>
                    </p-inputGroup>
                    <span *ngIf="isUploadFile" class="mt-2 font-italic text-500" >Cargando ...</span>
                  <p-button *ngIf="formFiles.controls['zipFile'].value !== null" 
                  label="Limpiar" [link]="true" (onClick)="onBack('project')"/>
                  <span *ngIf="formFiles.controls['zipFile'].errors" class="mt-3 font-italic text-red-500" >Error al cargar el archivo, extensiones validas <strong>.zip</strong> y <strong>.7z</strong></span>
                  <input id="input-zip" type="file" #zipInput accept=".zip, .7z" (change)="onFileSelected($event, 'zipFile')" style="display: none;">
                </div>
              </div>
              <div *ngIf="formFiles.get('type')?.value === 'git'" class="h-18rem border-round surface-ground conteiner-panel">
                <p>Ingresa la <strong>URL</strong> del repositorio de tu proyecto en Git Lab</p>
                <div class="flex-auto flex flex-column justify-content-center align-items-center">
                  <input type="text" pInputText formControlName="urlGit" placeholder="URl de tu proyecto" id="inputUrlGit"/>
                  <p-button *ngIf="formFiles.controls['urlGit'].value !== null" 
                  label="Limpiar" [link]="true" (onClick)="onBack('project')"/>
                  <span *ngIf="formFiles.controls['urlGit'].errors" class="mt-3 font-italic text-red-500" >URL invalida</span>
                </div>
              </div>
              <div class="flex pt-4 justify-content-between">
                <p-button label="Regresar" [outlined]="true" 
                icon="pi pi-arrow-left" (onClick)="prevCallback.emit()"/>
                <p-button label="Siguiente" icon="pi pi-arrow-right" iconPos="right"
                      [disabled]="isInputValid()" 
                      [outlined]="isInputValid()"
                      (onClick)="nextCallback.emit()" />
                    </div>
                  </ng-template>
          </p-stepperPanel>   
          <p-stepperPanel header="Seleccionar PDF*">
            <ng-template pTemplate="content" let-prevCallback="prevCallback" let-nextCallback="nextCallback" let-index="index">
              <div class="flex flex-column justify-content-center align-items-center h-18rem border-round surface-ground px-3">
                <p>Puedes añadir el archivo <strong>.pdf</strong> de las vulnerabilidades de tu proyecto.*</p>
                <div class="flex-auto flex flex-column justify-content-center align-items-center">
                  <p-inputGroup>
                    <button type="button" pButton label="Buscar" (click)="triggerFileInput('pdf')"></button>
                    <input type="text" pInputText placeholder="Selecciona tu pdf"
                      readonly disabled="true" id="inputpdfFile"
                      [value]="formFiles.controls['pdfFile'].value?.name ?? ''"/>
                  </p-inputGroup>
                  <span *ngIf="isUploadFile" class="mt-2 font-italic text-500" >
                    Cargando ...
                  </span>
                  <p-button *ngIf="formFiles.controls['pdfFile'].value !== null" 
                  label="Limpiar" [link]="true" (onClick)="onBack('pdf')"/>
                  <span *ngIf="formFiles.controls['pdfFile'].errors" class="font-italic text-red-500" >
                    Error al cargar el archivo, extensión valida <strong>.pdf</strong> 
                  </span>
                  <input id="input-pdf" type="file" #pdfInput accept=".pdf" (change)="onFileSelected($event, 'pdfFile')" style="display: none;">
                </div>
              </div>
              <div class="flex pt-4 justify-content-between">
                <p-button label="Regresar" icon="pi pi-arrow-left" 
                    *ngIf="!isUploadProject"  [outlined]="true"
                    (onClick)="prevCallback.emit()" 
                    />
                  <p-button label="Siguiente" icon="pi pi-arrow-right" iconPos="right"
                    [disabled]="formFiles.controls['pdfFile'].errors"
                    class="ml-auto" (onClick)="nextCallback.emit()"
                    [outlined]="formFiles.controls['pdfFile'].errors"
                  />
                </div>
                <div class="flex mt-4 justify-content-center">
                <p class="text-500 m-0 font-italic">* Este paso es opcional.</p>
              </div>
            </ng-template>
          </p-stepperPanel>
          <p-stepperPanel header="Resumen">
            <ng-template pTemplate="content" let-prevCallback="prevCallback" let-nextCallback="nextCallback" let-index="index">
              <div class="flex flex-column justify-content-center align-items-center  h-18rem border-round surface-ground px-3">
                <p>Se subirá tu proyecto son los siguientes elementos: </p>
                <div>
                  <p>
                    Acción: 
                      <strong>
                        {{ actionsOps[formFiles.controls['action'].value - 1].txt  }}
                      </strong>
                  </p>
                  <p *ngIf="formFiles.controls['action'].value === 3 && formFiles.get('language')?.value !== null">
                    Lenguaje para migrar: 
                    <strong>
                      {{ lenguagesOps[formFiles.controls['language'].value - 1].nom_lenguaje }}
                    </strong>
                  </p>
                  <p>
                    Tipo de proyecto: 
                    <strong>
                      {{ 
                        formFiles.controls['type'].value === 'zip' 
                        ? radioOps[0].tooltip 
                        : radioOps[1].tooltip 
                      }}
                    </strong>
                  </p>
                  <p>
                    Proyecto en: 
                    <strong>
                      {{ projectName }}
                    </strong>
                  </p>
                  <p>
                    PDF: 
                    <strong>
                      {{ 
                        formFiles.controls['pdfFile'].value 
                        ? formFiles.controls['pdfFile'].value.name 
                        : 'No aplica'
                      }}
                    </strong>
                  </p>
                </div>
              </div> 
              <div class="flex pt-4 justify-content-between">
                  <p-button label="Regresar" icon="pi pi-arrow-left" 
                    *ngIf="!isUploadProject" [outlined]="true"
                    (onClick)="prevCallback.emit()"
                  />
                  <p-button [label]="isUploadProject ? 'Subiendo...' : 'Subir proyecto'" 
                    severity="success" icon="pi pi-arrow-right" iconPos="right"
                    class="ml-auto" [loading]="isUploadProject"
                    (onClick)="uploadFiles()"
                  />
                </div>
              </ng-template>
            </p-stepperPanel>
          </p-stepper>
      </form>
    </div>
  </ng-template>
</main>