<main class="m-2">
    <section class="flex flex-column mt-3 md:flex-row">
        <h1 class="inline text-4xl text-center my-0 md:text-5xl md:text-left">
            Lista de aplicaciones
        </h1>
        <a
            *ngIf="user!.position.nom_rol !== Nom_Rols.INVITADO"
            pRipple
            routerLink="/apps/new-app"
            pTooltip="Subir una aplicación"
            tooltipPosition="left"
            tooltipStyleClass="text-sm"
            class="p-button font-bold mx-auto mt-4 md:mt-0 md:ml-auto md:mr-0 bnt-new">
            <span class="pi pi-plus-circle mr-2" style="font-size: 1.4rem"></span>
            Nueva aplicación
        </a>
    </section>

    <div *ngIf="isLoading && user!.position.nom_rol !== Nom_Rols.INVITADO" class="card flex justify-content-center my-6">
        <p-progressSpinner ariaLabel="loading" />
    </div>

    <div *ngIf="!isLoading && aplications.length === 0 || user!.position.nom_rol === Nom_Rols.INVITADO" class="my-6">
        <h2 class="text-center">
            ¡No hay aplicaciones para listar!
        </h2>
    </div>

    <section *ngIf="!isLoading && aplications.length > 0" class="mt-4">
        <div class="card">
            <p-table [value]="aplications" [tableStyle]="{ 'min-width': '100%', 'width': 'auto' }" [lazy]="true">
                <ng-template pTemplate="header">
                    <tr>
                        <th *ngFor="let col of colums">
                            {{ col }}
                        </th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-app let-index="rowIndex">
                    <tr>
                        <td>{{ app.sequentialId }}</td>
                        <td>{{ app.idu_proyecto }}</td>
                        <td *ngIf="user!.position.nom_rol !== Nom_Rols.INVITADO && 
                                   user!.position.nom_rol !== Nom_Rols.USUARIO">
                            {{ app.user.nom_usuario }}
                        </td>
                        <td>{{ app.nom_aplicacion }}</td>
                        <td>
                            <p-tag
                                styleClass="text-sm"
                                class="white-space-nowrap overflow-hidden text-overflow-ellipsis"
                                [severity]="app.applicationstatus.idu_estatus_aplicacion | statusAppLabel"
                                [value]="app.applicationstatus.idu_estatus_aplicacion | statusApp"
                            />
                        </td>
                        <td>
                            <div class="flex flex-col items-center" 
                                 (mouseenter)="onDropdownHover(app.sequentialId, index)" 
                                 (mouseleave)="onDropdownLeave(app.sequentialId, index)">
                                <p-dropdown 
                                    #dropdown
                                    [options]="getArquitecturaOptions(app.opc_arquitectura)"
                                    [placeholder]="getDropdownPlaceholder(app)"
                                    [disabled]="getArquitecturaOptions(app.opc_arquitectura).length === 0" 
                                    styleClass="dropdown-arrow-only w-full text-sm mt-1 dropdown-readonly"
                                    [style]="{'width': '100px', 'padding': '0 5px'}"
                                    [attr.data-id]="app.sequentialId + '-' + index">
                                    <ng-template let-option pTemplate="item">
                                        <span [ngClass]="option.styleClass" class="p-dropdown-item-custom">{{ option.label }}</span>
                                    </ng-template>
                                </p-dropdown>
                            </div>
                        </td>
                        
                        <td *ngIf="user!.position.nom_rol !== Nom_Rols.INVITADO">
                            <a *ngIf="app.applicationstatus.idu_estatus_aplicacion === StatusApps.DONE; else empty"
                               pTooltip="Descargar ZIP"
                               tooltipPosition="top"
                               tooltipStyleClass="text-sm"
                               class="c-pointer icon-down"
                               (click)="onDownloadFile(app)">
                                <i class="pi pi-arrow-circle-down" style="font-size: 1.6rem"></i>
                            </a>
                            <a *ngIf="app.num_accion === NumberAction.SANITIZECODE &&
                                    user!.position.nom_rol !== Nom_Rols.USUARIO"
                               [pTooltip]="app.checkmarx.length > 0 ? 'Ya se registró PDF' : 'Subir PDF'" 
                               tooltipPosition="top"
                               tooltipStyleClass="text-sm"
                               class=" mx-2"
                               [ngClass]="(app.applicationstatus.idu_estatus_aplicacion === StatusApps.DONE || app.checkmarx.length > 0) ? 'icon-disable' : 'icon-up'"
                               (click)="showFormUploadPDF(app)">
                                <i class="pi pi-file-pdf" style="font-size: 1.6rem"></i>
                            </a>
                            <ng-template #empty>
                                <a pTooltip="Descarga no disponible"
                                   tooltipPosition="top"
                                   tooltipStyleClass="text-sm"
                                   class="icon-disable">
                                    <i class="pi pi-arrow-circle-down" style="font-size: 1.6rem"></i>
                                </a>
                            </ng-template>
                        </td>
                        <td *ngIf="user!.position.nom_rol !== Nom_Rols.INVITADO">
                            {{ app.totalCost | currency:'USD':'symbol' }}
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
        <p-paginator
            (onPageChange)="onPageChange($event)"
            [first]="0"
            [rows]="elementPerPage"
            [totalRecords]="totalItems"
        />
    </section>
</main>

